<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calories Tracker</title>

  <!-- Materialize and Font Awesome -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <style>
    /* inline styling for the search bar */
    .search-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 20px 0;
    }

    #search-input {
      flex: 1;
      max-width: 400px;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    #search-btn {
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 15px;
      cursor: pointer;
      transition: 0.3s;
    }

    #search-btn:hover {
      background-color: #1565C0;
    }

    #search-results {
      margin-top: 20px;
    }

    .food-item {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      background: #f9f9f9;
    }

    .food-item:hover {
      background: #e3f2fd;
    }
  </style>
</head>

<body>
  <nav>
    <div class="nav-wrapper blue">
      <div class="container">
        <a href="index.html" class="brand-logo center">iCalorie</a>
        <ul>
          <li><a href="#" class="clear-btn btn blue lighten-3">Clear All</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <br>

  <div class="container">
    <!-- ðŸ” Search Bar -->
    <div class="search-container">
      <input type="text" id="search-input" placeholder="Search food (e.g. injera)">
      <button id="search-btn">Search</button>
    </div>

    <!-- ðŸ± Search Results -->
    <div id="search-results"></div>

    <!-- Existing Add Meal Section -->
    <div class="card">
      <div class="card-content">
        <span class="card-title">Add Meal / Food item</span>
        <form class="col">
          <div class="row">
            <div class="input-field col s6">
              <input type="text" placeholder="Add Item" id="item-name">
              <label for="item-name">Meal</label>
            </div>
            <div class="input-field col s6">
              <input type="number" placeholder="Add Calories" id="item-calories">
              <label for="item-calories">Calories</label>
            </div>
          </div>
          <div class="row">
            <button class="btn add-btn blue darken-3"><i class="fa fa-plus"></i> Add Meal</button>
            <button class="btn update-btn orange"><i class="fa fa-pencil-square-o"></i> Update Meal</button>
            <button class="btn delete-btn red"><i class="fa fa-remove"></i> Delete Meal</button>
            <button class="btn back-btn grey pull-right"><i class="fa fa-chevron-circle-left"></i> Back</button>
          </div>
          <p><a target="_blank" href="calorie.html">Calories in common dishes</a></p>
        </form>
      </div>
    </div>

    <!-- Total calories -->
    <h3 class="center-align">Total calories: <span class="total-calories">0</span></h3>

    <!-- Item list -->
    <ul id="item-list" class="collection"></ul>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="app.js"></script>

  <!-- ðŸŒ Search Logic -->
  <script type="module">
    import { fetchFoodInfo } from "./calorieinfo.js";

    const searchBtn = document.getElementById("search-btn");
    const searchInput = document.getElementById("search-input");
    const resultsDiv = document.getElementById("search-results");

    const mealInput = document.getElementById("item-name");
    const caloriesInput = document.getElementById("item-calories");

    // When user clicks search
    searchBtn.addEventListener("click", async () => {
      const query = searchInput.value.trim();
      if (!query) return;

      resultsDiv.innerHTML = "<p>Loading...</p>";

      try {
        const data = await fetchFoodInfo(query);
        const foods = data.foods?.food;
        if (!foods || foods.length === 0) {
          resultsDiv.innerHTML = "<p>No results found.</p>";
          return;
        }

        // Create clickable search results
        resultsDiv.innerHTML = foods.map(f => `
          <div class="food-item" data-name="${f.food_name}" data-desc="${f.food_description}">
            <strong>${f.food_name}</strong><br>
            <em>${f.food_description}</em>
          </div>
        `).join("");

        // Attach click events
        document.querySelectorAll(".food-item").forEach(item => {
          item.addEventListener("click", () => {
            const name = item.getAttribute("data-name");
            const desc = item.getAttribute("data-desc");

            // Extract calories from description text (FatSecret API provides it inside description)
            const calMatch = desc.match(/(\d+)\s*cal/i);
            const calories = calMatch ? parseInt(calMatch[1]) : "";

            mealInput.value = name;
            caloriesInput.value = calories;
            M.updateTextFields(); // Materialize updates labels dynamically

            resultsDiv.innerHTML = ""; // Clear search results after selection
          });
        });

      } catch (err) {
        resultsDiv.innerHTML = `<p style="color:red;">Error fetching data: ${err.message}</p>`;
      }
    });
  </script>
</body>
</html>
